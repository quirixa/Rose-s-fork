<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
    <title>Galactic Defender | Space Shooter</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #00ff88;
            --secondary-color: #0088ff;
            --danger-color: #ff4444;
            --warning-color: #ffaa00;
            --bg-dark: #0a0a16;
            --bg-darker: #050510;
            --neon-glow: 0 0 20px;
        }
        * { box-sizing: border-box; margin:0; padding:0; }
        body {
            font-family: 'Orbitron', 'Courier New', monospace;
            background: var(--bg-darker);
            overflow: hidden;
            user-select: none;
            min-height: 100vh;
            display:flex;
            justify-content:center;
            align-items:center;
            background-image:
                radial-gradient(circle at 10% 20%, rgba(0,40,80,0.2) 0%, transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(0,100,100,0.2) 0%, transparent 20%);
        }
        .game-container { position:relative; max-width:1200px; width:100%; padding:20px; }
        #gameCanvas {
            display:block;
            cursor: crosshair;
            background: linear-gradient(135deg, #0c0c0c 0%, #1a1a2e 50%, #16213e 100%);
            border-radius:12px;
            box-shadow: 0 0 80px rgba(0,255,136,0.15), inset 0 0 40px rgba(0,0,0,0.5);
            border: 1px solid rgba(0,255,136,0.1);
            width:100%;
            height:auto;
        }
        #ui {
            position:absolute; top:30px; left:30px; color:var(--primary-color); font-size:20px; font-weight:bold;
            text-shadow: var(--neon-glow) var(--primary-color); z-index:10;
            background: rgba(10,10,22,0.85); padding:20px 25px; border-radius:15px;
            border: 2px solid rgba(0,255,136,0.3); backdrop-filter: blur(8px); box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .ui-item { margin-bottom:15px; display:flex; justify-content:space-between; min-width:220px; align-items:center; }
        .ui-label { color:#aaffcc; margin-right:15px; }
        .ui-value { color:#ffffff; font-weight:normal; font-size:24px; text-shadow:0 0 10px #ffffff; }
        #startScreen, #gameOver {
            position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); text-align:center; z-index:20;
            background: rgba(5,5,16,0.95); padding:60px 70px; border-radius:25px; backdrop-filter: blur(15px);
        }
        #startScreen { color:var(--primary-color); border:3px solid var(--primary-color); box-shadow: 0 0 60px rgba(0,255,136,0.4); max-width:800px; width:90%; }
        #gameOver { color:var(--danger-color); border:3px solid var(--danger-color); box-shadow:0 0 60px rgba(255,68,68,0.4); max-width:700px; width:90%; display:none;}
        .game-title { font-size:5rem; margin-bottom:40px; animation:pulse 2s infinite, float 6s ease-in-out infinite; letter-spacing:6px;
            background:linear-gradient(to right, var(--primary-color), var(--secondary-color)); -webkit-background-clip:text; background-clip:text; color:transparent; margin-top:0; position:relative;
        }
        .game-title::after { content:''; position:absolute; bottom:-15px; left:25%; width:50%; height:3px; background:linear-gradient(to right, transparent, var(--primary-color), transparent); }
        .controls-grid { display:grid; grid-template-columns:repeat(2,1fr); gap:40px; margin:40px 0; padding:0 20px; }
        .control-section { text-align:center; padding:20px; background: rgba(0,40,80,0.2); border-radius:15px; border:1px solid rgba(0,136,255,0.3); }
        .control-title { color:var(--secondary-color); margin-bottom:20px; font-size:1.5rem; text-shadow:0 0 15px var(--secondary-color); }
        .keys-row { display:flex; justify-content:center; gap:10px; margin-bottom:10px; }
        .key { display:inline-block; background: rgba(0,136,255,0.2); border:2px solid var(--secondary-color); color:var(--secondary-color); padding:12px 20px; border-radius:8px; font-weight:bold; min-width:60px; font-size:1.2rem; text-shadow:0 0 10px var(--secondary-color); }
        .game-btn { background: linear-gradient(135deg, rgba(0,255,136,0.2) 0%, rgba(0,136,255,0.2) 100%); border:2px solid var(--primary-color); color:var(--primary-color); padding:22px 50px; font-family:inherit; font-size:1.5rem; font-weight:bold; cursor:pointer; margin-top:30px; transition:all .3s ease; border-radius:15px; letter-spacing:2px; text-transform:uppercase; position:relative; overflow:hidden; z-index:1; box-shadow:0 10px 30px rgba(0,255,136,0.2); }
        .game-btn:hover { transform: scale(1.05); box-shadow: 0 15px 40px rgba(0,255,136,0.3); }
        .hidden { display:none !important; }
        #waveAlert { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); color:var(--primary-color); font-size:3.5rem; font-weight:bold; text-shadow:0 0 30px var(--primary-color); z-index:15; opacity:0; pointer-events:none; }
        .powerup-display { position:absolute; bottom:30px; left:30px; color:var(--secondary-color); font-size:16px; background: rgba(10,10,22,0.85); padding:15px 20px; border-radius:12px; border:2px solid rgba(0,136,255,0.3); backdrop-filter: blur(8px); box-shadow:0 10px 30px rgba(0,0,0,0.5); }
        .game-over-title { font-size:4rem; margin-bottom:30px; }
        .stats { display:flex; justify-content:space-around; margin:30px 0; padding:20px; background: rgba(255,68,68,0.1); border-radius:15px; border:1px solid rgba(255,68,68,0.3); }
        .stat-value { font-size:2.5rem; color:white; display:block; text-shadow:0 0 10px white; }
        .stat-label { color:#ffaaaa; font-size:1rem; margin-top:5px; }
        .instructions { margin-top:40px; font-size:1rem; opacity:0.8; color:#88ffaa; padding:20px; background: rgba(0,40,60,0.3); border-radius:10px; border-left:3px solid var(--secondary-color); }
        
        /* Enhanced Game Over Screen Styles */
        .restart-options {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 30px;
            width: 100%;
        }
        
        .restart-main {
            background: linear-gradient(135deg, rgba(255, 68, 68, 0.2) 0%, rgba(255, 136, 0, 0.2) 100%) !important;
            border-color: var(--danger-color) !important;
            color: var(--danger-color) !important;
            animation: pulse 1.5s infinite;
        }
        
        .menu-btn {
            background: rgba(0, 136, 255, 0.2) !important;
            border-color: var(--secondary-color) !important;
            color: var(--secondary-color) !important;
        }
        
        .restart-main:hover {
            transform: scale(1.05);
            box-shadow: 0 0 40px rgba(255, 68, 68, 0.4) !important;
        }
        
        .menu-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 40px rgba(0, 136, 255, 0.4) !important;
        }
        
        .mission-failed-text {
            color: var(--danger-color);
            font-size: 1.2rem;
            margin-bottom: 30px;
            text-shadow: 0 0 10px rgba(255, 68, 68, 0.5);
        }
        
        .high-score-notice {
            color: var(--warning-color);
            font-size: 1.1rem;
            margin: 10px 0;
            padding: 10px;
            background: rgba(255, 170, 0, 0.1);
            border-radius: 8px;
            border: 1px solid rgba(255, 170, 0, 0.3);
            display: none;
        }
        
        @keyframes pulse { 0%,100%{opacity:1}50%{opacity:0.8} }
        @keyframes float { 0%,100%{transform:translateY(0)}50%{transform:translateY(-10px)} }
        @keyframes shake { 0%,100%{transform:translateX(0)} 10%,30%,50%,70%,90%{transform:translateX(-5px)} 20%,40%,60%,80%{transform:translateX(5px)} }
        
        @media (max-width:768px) {
            .game-title { font-size:3rem; }
            #startScreen, #gameOver { padding:30px; }
            .controls-grid { grid-template-columns:1fr; gap:20px; }
            #ui { padding:15px; font-size:16px; top:20px; left:20px; }
            .game-btn { padding:18px 30px; font-size:1.2rem; }
            .restart-options { flex-direction: column; }
            .game-over-title { font-size:2.5rem; }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <canvas id="gameCanvas"></canvas>

        <div id="ui">
            <div class="ui-item"><span class="ui-label"><i class="fas fa-star"></i> SCORE</span><span class="ui-value" id="score">0</span></div>
            <div class="ui-item"><span class="ui-label"><i class="fas fa-heart"></i> LIVES</span><span class="ui-value" id="lives">3</span></div>
            <div class="ui-item"><span class="ui-label"><i class="fas fa-wave-square"></i> WAVE</span><span class="ui-value" id="wave">1</span></div>
            <div class="ui-item"><span class="ui-label"><i class="fas fa-trophy"></i> HIGH SCORE</span><span class="ui-value" id="highScore">0</span></div>
        </div>

        <div class="powerup-display"><i class="fas fa-bolt"></i> POWER-UPS: <span id="powerups">0</span></div>

        <div id="startScreen">
            <h1 class="game-title">GALACTIC DEFENDER</h1>
            <p class="mission-brief">Alien organisms have breached the outer colonies. You are the last defender.</p>

            <div class="controls-grid">
                <div class="control-section">
                    <h3 class="control-title">MOVEMENT</h3>
                    <div class="keys-row">
                        <div class="key">W</div>
                        <div class="key">A</div>
                        <div class="key">S</div>
                        <div class="key">D</div>
                    </div>
                    <div class="keys-row">
                        <div class="key">↑</div>
                        <div class="key">←</div>
                        <div class="key">↓</div>
                        <div class="key">→</div>
                    </div>
                </div>
                <div class="control-section">
                    <h3 class="control-title">ACTIONS</h3>
                    <div class="keys-row"><div class="key" style="min-width:120px;">SPACE</div></div>
                    <p style="margin:10px 0; color:#aaa;">OR</p>
                    <div class="keys-row"><div class="key" style="min-width:120px;">CLICK</div></div>
                    <p style="margin-top:10px; color:var(--primary-color);">SHOOT</p>
                </div>
            </div>

            <p>Collect power-ups for special abilities and upgrades!</p>
            <p>Survive as long as possible and achieve the highest score!</p>

            <button id="startBtn" class="game-btn"><i class="fas fa-rocket"></i> START MISSION</button>

            <div class="instructions">
                <p><i class="fas fa-lightbulb"></i> TIP: Move quickly to avoid enemy fire and target weak points on larger ships. Watch for power-up drops!</p>
                <p style="margin-top: 10px; font-size: 0.9rem;"><i class="fas fa-gamepad"></i> PRESS 'R' TO RESTART DURING GAMEPLAY</p>
            </div>
        </div>

        <div id="gameOver" class="hidden">
            <h2 class="game-over-title">MISSION FAILED</h2>
            <p class="mission-failed-text">Your ship has been destroyed in combat!</p>
            
            <div class="high-score-notice" id="newHighScore">
                <i class="fas fa-trophy"></i> NEW HIGH SCORE ACHIEVED!
            </div>
            
            <div class="stats">
                <div class="stat-item">
                    <span class="stat-value" id="finalScore">0</span>
                    <span class="stat-label">FINAL SCORE</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value" id="finalWave">1</span>
                    <span class="stat-label">HIGHEST WAVE</span>
                </div>
            </div>
            
            <div class="restart-options">
                <button id="restartBtn" class="game-btn restart-main">
                    <i class="fas fa-redo"></i> RESTART MISSION
                </button>
                <button id="menuBtn" class="game-btn menu-btn">
                    <i class="fas fa-home"></i> MAIN MENU
                </button>
            </div>
            
            <div class="instructions" style="margin-top: 20px;">
                <p><i class="fas fa-star"></i> Defeat enemies to earn points</p>
                <p><i class="fas fa-skull-crossbones"></i> Brute enemies require 3 hits to destroy</p>
                <p><i class="fas fa-bolt"></i> Collect power-ups for advantages</p>
            </div>
        </div>

        <div id="waveAlert" class="wave-alert hidden"></div>
    </div>

    <script>
    // ---------- Canvas + Basic Setup ----------
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');

    const ui = {
        score: document.getElementById('score'),
        lives: document.getElementById('lives'),
        wave: document.getElementById('wave'),
        highScore: document.getElementById('highScore'),
        startScreen: document.getElementById('startScreen'),
        startBtn: document.getElementById('startBtn'),
        gameOver: document.getElementById('gameOver'),
        finalScore: document.getElementById('finalScore'),
        finalWave: document.getElementById('finalWave'),
        restartBtn: document.getElementById('restartBtn'),
        menuBtn: document.getElementById('menuBtn'),
        powerups: document.getElementById('powerups'),
        newHighScore: document.getElementById('newHighScore')
    };

    let gameRunning = false;
    let score = 0;
    let lives = 3;
    let wave = 1;
    let enemySpawnTimer = 0;
    let waveTimer = 0;
    let highScore = parseInt(localStorage.getItem('galactic_high') || '0', 10);
    let achievedNewHighScore = false;

    let player = {};
    let bullets = [];
    let enemies = [];
    let particles = [];
    let powerUps = [];

    let keys = {};
    let mouseX = 0;
    let mouseY = 0;
    let shooting = false;

    function resizeCanvas(){
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    function random(min, max){ return Math.random() * (max - min) + min; }
    function distance(x1,y1,x2,y2){ return Math.hypot(x2-x1, y2-y1); }
    function angle(x1,y1,x2,y2){ return Math.atan2(y2-y1, x2-x1); }

    // ---------- Initialization ----------
    function initGame(){
        score = 0;
        lives = 3;
        wave = 1;
        enemySpawnTimer = 0;
        waveTimer = 0;
        achievedNewHighScore = false;
        bullets = [];
        enemies = [];
        particles = [];
        powerUps = [];
        
        player = {
            x: canvas.width / 2,
            y: canvas.height / 2,
            size: 14,
            speed: 5,
            shootCooldown: 0,
            fireRate: 10,
            isInvulnerable: false,
            invulnerabilityTimer: 0
        };
        
        updateUI();
        ui.highScore.textContent = highScore;
        ui.newHighScore.style.display = 'none';
    }

    function startGame(){
        gameRunning = true;
        ui.startScreen.classList.add('hidden');
        ui.gameOver.classList.add('hidden');
        initGame();
        gameLoop();
    }

    function endGame(){
        gameRunning = false;
        
        // Check for new high score
        if(score > highScore){
            highScore = score;
            achievedNewHighScore = true;
            localStorage.setItem('galactic_high', highScore);
            ui.newHighScore.style.display = 'block';
            ui.newHighScore.style.animation = 'pulse 1s infinite, shake 0.5s';
        } else {
            ui.newHighScore.style.display = 'none';
        }
        
        // Update UI
        ui.finalScore.textContent = score;
        ui.finalWave.textContent = wave;
        ui.gameOver.classList.remove('hidden');
        ui.highScore.textContent = highScore;
        
        // Add explosion particles at player position
        for(let i = 0; i < 50; i++) {
            spawnParticle(player.x, player.y, 
                i % 3 === 0 ? '#ff4444' : i % 3 === 1 ? '#ffaa00' : '#ffffff',
                random(2, 6));
        }
    }

    function updateUI(){
        ui.score.textContent = score;
        ui.lives.textContent = lives;
        ui.wave.textContent = wave;
        ui.powerups.textContent = powerUps.length;
        
        // Pulse score when it's high
        if(score > 1000) {
            ui.score.style.animation = 'pulse 0.5s infinite';
        } else {
            ui.score.style.animation = '';
        }
    }

    // ---------- Spawning enemies ----------
    function spawnEnemy(){
        const side = Math.floor(Math.random() * 4);
        let x, y;
        switch(side){
            case 0: x = random(0, canvas.width); y = -40; break;
            case 1: x = canvas.width + 40; y = random(0, canvas.height); break;
            case 2: x = random(0, canvas.width); y = canvas.height + 40; break;
            default: x = -40; y = random(0, canvas.height); break;
        }

        // Determine enemy species
        const r = Math.random();
        let species = 'crawler';
        if (r > 0.7) species = 'stalker';
        if (r > 0.92) species = 'brute';

        enemies.push({
            x, y,
            species,
            size: species === 'brute' ? 28 : species === 'stalker' ? 14 : 18,
            speed: species === 'stalker' ? random(2.6, 3.6) : species === 'brute' ? random(0.6, 1.0) : random(1.2, 1.9),
            hp: species === 'brute' ? 3 : 1,
            maxHp: species === 'brute' ? 3 : 1,
            wobble: Math.random() * Math.PI * 2,
            color: species === 'brute' ? '#ff6b6b' : species === 'stalker' ? '#c96bff' : '#5aff8a'
        });
    }

    // ---------- Particles ----------
    function spawnParticle(x,y,color,count=8){
        for(let i=0;i<count;i++){
            particles.push({
                x, y,
                vx: random(-4,4),
                vy: random(-4,4),
                life: random(20,40),
                size: random(2,5),
                color
            });
        }
    }

    // ---------- Powerups ----------
    function spawnPowerUp(x,y){
        const types = ['rapid', 'shield', 'double', 'health'];
        const type = types[Math.floor(Math.random() * types.length)];
        
        powerUps.push({
            x, y,
            type: type,
            life: 600,
            size: 10,
            color: type === 'rapid' ? '#00ff88' : 
                   type === 'shield' ? '#0088ff' : 
                   type === 'double' ? '#ffaa00' : 
                   '#ff4444'
        });
    }

    // ---------- Drawing functions ----------
    function drawBackground(){
        // Star field
        ctx.fillStyle = 'rgba(0,0,0,0.12)';
        ctx.fillRect(0,0,canvas.width,canvas.height);
        
        // Static stars
        ctx.fillStyle = 'rgba(255,255,255,0.8)';
        for(let i=0;i<120;i++){
            const sx = (i * 211.123) % canvas.width;
            const sy = (i * 97.321) % canvas.height;
            ctx.fillRect(sx, sy, 1, 1);
        }
        
        // Moving stars (parallax effect)
        ctx.fillStyle = 'rgba(255,255,255,0.4)';
        const time = Date.now() * 0.001;
        for(let i=0;i<40;i++){
            const sx = (i * 137.579 + time * 20) % canvas.width;
            const sy = (i * 89.123 + time * 10) % canvas.height;
            ctx.fillRect(sx, sy, 1, 1);
        }
    }

    function drawPlayer(){
        if (player.isInvulnerable && Math.floor(Date.now() / 100) % 2 === 0) {
            return; // Flash effect when invulnerable
        }
        
        const a = angle(player.x, player.y, mouseX, mouseY);
        ctx.save();
        ctx.translate(player.x, player.y);
        ctx.rotate(a);

        // Engine flame (pulsing)
        const flameLen = 12 + Math.sin(Date.now() / 100) * 4;
        const gradient = ctx.createLinearGradient(-18, 0, -18 - flameLen, 0);
        gradient.addColorStop(0, 'rgba(0,255,136,0.45)');
        gradient.addColorStop(1, 'rgba(255,255,0,0.2)');
        ctx.fillStyle = gradient;
        ctx.beginPath();
        ctx.moveTo(-18, 0);
        ctx.lineTo(-18 - flameLen, -6);
        ctx.lineTo(-18 - flameLen * 0.8, 0);
        ctx.lineTo(-18 - flameLen, 6);
        ctx.closePath();
        ctx.fill();

        // Ship body
        ctx.fillStyle = '#00ff88';
        ctx.strokeStyle = 'rgba(170,255,204,0.9)';
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(20,0); // nose
        ctx.lineTo(-8, -12); // left
        ctx.lineTo(-2, 0); // mid
        ctx.lineTo(-8, 12); // right
        ctx.closePath();
        ctx.fill();
        ctx.stroke();

        // Cockpit
        ctx.fillStyle = 'rgba(255,255,255,0.9)';
        ctx.beginPath();
        ctx.arc(6, 0, 3, 0, Math.PI * 2);
        ctx.fill();

        ctx.restore();
    }

    function drawLaser(b){
        ctx.lineWidth = 3;
        const gradient = ctx.createLinearGradient(b.x, b.y, b.x - b.vx * 2, b.y - b.vy * 2);
        gradient.addColorStop(0, 'rgba(0,255,136,0.95)');
        gradient.addColorStop(1, 'rgba(0,136,255,0.7)');
        ctx.strokeStyle = gradient;
        ctx.beginPath();
        ctx.moveTo(b.x, b.y);
        ctx.lineTo(b.x - b.vx * 2, b.y - b.vy * 2);
        ctx.stroke();
        
        // Glow effect
        ctx.lineWidth = 1;
        ctx.strokeStyle = 'rgba(0,255,136,0.3)';
        ctx.beginPath();
        ctx.moveTo(b.x, b.y);
        ctx.lineTo(b.x - b.vx * 1.5, b.y - b.vy * 1.5);
        ctx.stroke();
    }

    function drawCrawler(e){
        ctx.save();
        ctx.translate(e.x, e.y);
        const pulse = 1 + Math.sin((Date.now() + e.wobble*200) / 250) * 0.06;
        ctx.fillStyle = e.color;
        ctx.beginPath();
        ctx.arc(0, 0, e.size * pulse, 0, Math.PI * 2);
        ctx.fill();

        // Eye
        ctx.fillStyle = '#000';
        ctx.beginPath();
        ctx.arc(e.size * 0.35, 0, Math.max(2, e.size * 0.28), 0, Math.PI * 2);
        ctx.fill();
        ctx.fillStyle = '#fff';
        ctx.beginPath();
        ctx.arc(e.size * 0.42, -2, Math.max(1, e.size * 0.08), 0, Math.PI * 2);
        ctx.fill();

        ctx.restore();
    }

    function drawStalker(e){
        const a = angle(e.x, e.y, player.x, player.y);
        ctx.save();
        ctx.translate(e.x, e.y);
        ctx.rotate(a);
        ctx.fillStyle = e.color;
        ctx.beginPath();
        ctx.moveTo(16,0);
        ctx.lineTo(-10, -8);
        ctx.lineTo(-4, 0);
        ctx.lineTo(-10, 8);
        ctx.closePath();
        ctx.fill();
        
        // Glowing effect
        ctx.strokeStyle = 'rgba(201,107,255,0.5)';
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(14,0);
        ctx.lineTo(-8, -6);
        ctx.lineTo(-2, 0);
        ctx.lineTo(-8, 6);
        ctx.closePath();
        ctx.stroke();
        
        ctx.restore();
    }

    function drawBrute(e){
        ctx.save();
        ctx.translate(e.x, e.y);
        
        // Health bar
        if (e.hp < e.maxHp) {
            ctx.fillStyle = 'rgba(0,0,0,0.7)';
            ctx.fillRect(-e.size, -e.size - 10, e.size * 2, 5);
            ctx.fillStyle = '#ff4444';
            ctx.fillRect(-e.size, -e.size - 10, (e.hp / e.maxHp) * e.size * 2, 5);
        }
        
        // Main body
        ctx.fillStyle = e.color;
        ctx.beginPath();
        ctx.arc(0,0,e.size,0,Math.PI*2);
        ctx.fill();
        
        // Armor ring
        ctx.strokeStyle = 'rgba(136,0,0,0.7)';
        ctx.lineWidth = 4;
        ctx.beginPath();
        ctx.arc(0,0,e.size - 6,0,Math.PI*2);
        ctx.stroke();

        // Grate/eye
        ctx.fillStyle = 'rgba(0,0,0,0.8)';
        ctx.fillRect(-Math.min(12, e.size*0.4), -4, Math.min(24, e.size*0.8), 8);

        ctx.restore();
    }

    function drawAllEnemies(){
        for(const e of enemies){
            if (e.species === 'crawler') drawCrawler(e);
            else if (e.species === 'stalker') drawStalker(e);
            else if (e.species === 'brute') drawBrute(e);
        }
    }

    // ---------- Update logic ----------
    function update(){
        if(!gameRunning) return;

        // Player invulnerability
        if (player.isInvulnerable) {
            player.invulnerabilityTimer--;
            if (player.invulnerabilityTimer <= 0) {
                player.isInvulnerable = false;
            }
        }

        // Player movement
        if (keys['w'] || keys['ArrowUp']) player.y -= player.speed;
        if (keys['s'] || keys['ArrowDown']) player.y += player.speed;
        if (keys['a'] || keys['ArrowLeft']) player.x -= player.speed;
        if (keys['d'] || keys['ArrowRight']) player.x += player.speed;

        // Keep player in bounds
        player.x = Math.max(player.size, Math.min(canvas.width - player.size, player.x));
        player.y = Math.max(player.size, Math.min(canvas.height - player.size, player.y));

        // Shooting
        if (player.shootCooldown > 0) player.shootCooldown--;
        if ((shooting || keys[' ']) && player.shootCooldown <= 0){
            const a = angle(player.x, player.y, mouseX, mouseY);
            bullets.push({
                x: player.x + Math.cos(a) * (player.size + 4),
                y: player.y + Math.sin(a) * (player.size + 4),
                vx: Math.cos(a) * 10,
                vy: Math.sin(a) * 10,
                life: 120
            });
            player.shootCooldown = player.fireRate;
        }

        // Update bullets
        for(let i = bullets.length - 1; i >= 0; i--){
            const b = bullets[i];
            b.x += b.vx;
            b.y += b.vy;
            b.life--;
            if (b.life <= 0 || b.x < -50 || b.x > canvas.width + 50 || b.y < -50 || b.y > canvas.height + 50){
                bullets.splice(i,1);
            }
        }

        // Update enemies
        for(let i = enemies.length - 1; i >= 0; i--){
            const e = enemies[i];

            // Movement toward player
            const dx = player.x - e.x;
            const dy = player.y - e.y;
            const dist = Math.hypot(dx, dy) || 1;
            let nx = dx / dist;
            let ny = dy / dist;

            if (e.species === 'stalker'){
                e.wobble += 0.15;
                const side = Math.sin(e.wobble) * 0.6;
                const perpX = -ny;
                const perpY = nx;
                nx += perpX * side;
                ny += perpY * side;
                const len = Math.hypot(nx, ny) || 1;
                nx /= len; ny /= len;
            }

            e.x += nx * e.speed;
            e.y += ny * e.speed;

            // Collision with player
            if (!player.isInvulnerable && distance(e.x, e.y, player.x, player.y) < e.size + player.size - 2){
                spawnParticle(e.x, e.y, 'rgba(255,80,80,0.9)', 12);
                spawnParticle(player.x, player.y, 'rgba(255,255,255,0.9)', 8);
                enemies.splice(i,1);
                
                lives--;
                player.isInvulnerable = true;
                player.invulnerabilityTimer = 60; // 1 second invulnerability
                
                if (lives <= 0){
                    endGame();
                    return;
                }
                continue;
            }

            // Collision with bullets
            for(let j = bullets.length - 1; j >= 0; j--){
                const b = bullets[j];
                if (distance(b.x, b.y, e.x, e.y) < e.size + 4){
                    e.hp--;
                    spawnParticle(b.x, b.y, 'rgba(255,255,255,0.9)', 6);
                    bullets.splice(j,1);
                    
                    if (e.hp <= 0){
                        // Enemy dies
                        spawnParticle(e.x, e.y, e.color, 12);
                        
                        // Chance to drop powerup
                        if (Math.random() < 0.08) spawnPowerUp(e.x, e.y);
                        
                        // Scoring
                        score += e.species === 'brute' ? 30 : e.species === 'stalker' ? 15 : 10;
                        enemies.splice(i,1);
                    } else {
                        // Hit but alive
                        score += 2;
                        spawnParticle(e.x, e.y, '#ffffff', 3);
                    }
                    break;
                }
            }
        }

        // Update particles
        for(let i = particles.length - 1; i >= 0; i--){
            const p = particles[i];
            p.x += p.vx;
            p.y += p.vy;
            p.vx *= 0.98;
            p.vy *= 0.98;
            p.life--;
            if (p.life <= 0) particles.splice(i,1);
        }

        // Update powerUps
        for(let i = powerUps.length - 1; i >= 0; i--){
            const pu = powerUps[i];
            pu.life--;
            
            // Check collision with player
            if (distance(pu.x, pu.y, player.x, player.y) < pu.size + player.size) {
                // Apply powerup effect
                switch(pu.type) {
                    case 'rapid':
                        player.fireRate = Math.max(3, player.fireRate - 2);
                        break;
                    case 'health':
                        lives = Math.min(5, lives + 1);
                        break;
                    case 'double':
                        // Double shot effect would go here
                        break;
                    case 'shield':
                        player.isInvulnerable = true;
                        player.invulnerabilityTimer = 180; // 3 seconds
                        break;
                }
                
                spawnParticle(pu.x, pu.y, pu.color, 15);
                powerUps.splice(i,1);
                continue;
            }
            
            if (pu.life <= 0) powerUps.splice(i,1);
        }

        // Spawn enemies
        enemySpawnTimer++;
        const spawnRate = Math.max(20, 110 - wave * 8);
        if (enemySpawnTimer >= spawnRate){
            spawnEnemy();
            enemySpawnTimer = 0;
        }

        // Wave progression
        waveTimer++;
        if (waveTimer >= 1800 && enemies.length === 0){
            wave++;
            waveTimer = 0;
            
            // Spawn wave burst
            for(let i=0;i<Math.min(8, wave+2);i++){
                setTimeout(()=> spawnEnemy(), i * 140);
            }
        }

        updateUI();
    }

    // ---------- Rendering ----------
    function draw(){
        drawBackground();

        // Draw particles
        for(const p of particles){
            const alpha = Math.max(0, p.life / 40);
            ctx.fillStyle = (p.color || 'rgba(255,255,255,0.9)').replace(')', `,${alpha})`).replace('rgba(','rgba(');
            ctx.beginPath();
            ctx.arc(p.x, p.y, p.size, 0, Math.PI*2);
            ctx.fill();
        }

        // Draw bullets
        for(const b of bullets) drawLaser(b);

        // Draw enemies
        drawAllEnemies();

        // Draw powerUps
        for(const pu of powerUps){
            ctx.save();
            ctx.globalAlpha = 0.8 + Math.sin(Date.now() / 200) * 0.2;
            ctx.strokeStyle = pu.color;
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.arc(pu.x, pu.y, pu.size, 0, Math.PI*2);
            ctx.stroke();
            
            // Inner icon
            ctx.fillStyle = pu.color;
            ctx.beginPath();
            if (pu.type === 'rapid') {
                ctx.moveTo(pu.x - 4, pu.y);
                ctx.lineTo(pu.x + 4, pu.y);
                ctx.lineTo(pu.x, pu.y + 6);
                ctx.closePath();
            } else if (pu.type === 'health') {
                ctx.beginPath();
                ctx.moveTo(pu.x, pu.y - 5);
                ctx.lineTo(pu.x - 4, pu.y + 2);
                ctx.lineTo(pu.x, pu.y + 6);
                ctx.lineTo(pu.x + 4, pu.y + 2);
                ctx.closePath();
            } else {
                ctx.beginPath();
                ctx.arc(pu.x, pu.y, 3, 0, Math.PI*2);
            }
            ctx.fill();
            ctx.restore();
        }

        // Draw player
        drawPlayer();
    }

    // ---------- Main loop ----------
    function gameLoop(){
        update();
        draw();
        if (gameRunning) requestAnimationFrame(gameLoop);
    }

    // ---------- Input Handling ----------
    window.addEventListener('keydown', (e)=>{
        keys[e.key.toLowerCase()] = true;
        if (e.key === ' ') e.preventDefault();
        
        // R key to restart during gameplay
        if ((e.key === 'r' || e.key === 'R') && gameRunning) {
            if(confirm("Restart mission? Current progress will be lost.")) {
                startGame();
            }
        }
        
        // Escape to pause (placeholder)
        if (e.key === 'Escape' && gameRunning) {
            // Pause functionality could be added here
        }
    });
    
    window.addEventListener('keyup', (e)=>{
        keys[e.key.toLowerCase()] = false;
    });

    canvas.addEventListener('mousemove', (e)=>{
        const rect = canvas.getBoundingClientRect();
        mouseX = e.clientX - rect.left;
        mouseY = e.clientY - rect.top;
    });

    canvas.addEventListener('mousedown', (e)=>{
        shooting = true;
        if (!gameRunning && !ui.startScreen.classList.contains('hidden')) startGame();
    });
    
    canvas.addEventListener('mouseup', ()=>{ shooting = false; });

    // Touch support
    canvas.addEventListener('touchstart', (e)=>{
        e.preventDefault();
        const t = e.touches[0];
        const rect = canvas.getBoundingClientRect();
        mouseX = t.clientX - rect.left;
        mouseY = t.clientY - rect.top;
        shooting = true;
        if (!gameRunning && !ui.startScreen.classList.contains('hidden')) startGame();
    }, {passive:false});
    
    canvas.addEventListener('touchmove', (e)=>{
        e.preventDefault();
        const t = e.touches[0];
        const rect = canvas.getBoundingClientRect();
        mouseX = t.clientX - rect.left;
        mouseY = t.clientY - rect.top;
    }, {passive:false});
    
    canvas.addEventListener('touchend', (e)=>{ 
        e.preventDefault(); 
        shooting = false; 
    }, {passive:false});

    // Button event listeners
    ui.startBtn.addEventListener('click', startGame);
    ui.restartBtn.addEventListener('click', startGame);
    ui.menuBtn.addEventListener('click', () => {
        gameRunning = false;
        ui.gameOver.classList.add('hidden');
        ui.startScreen.classList.remove('hidden');
    });

    // Initial setup
    drawBackground();
    drawPlayer();
    ui.highScore.textContent = highScore;

    // Add visual feedback for button clicks
    document.querySelectorAll('.game-btn').forEach(btn => {
        btn.addEventListener('mousedown', () => {
            btn.style.transform = 'scale(0.95)';
        });
        btn.addEventListener('mouseup', () => {
            btn.style.transform = '';
        });
        btn.addEventListener('mouseleave', () => {
            btn.style.transform = '';
        });
    });

    </script>
</body>
</html>
